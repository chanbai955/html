<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Expense Tracker (INR to MYR)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }
    .tracker {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    h2 {
      text-align: center;
    }
    .input-group {
      margin-bottom: 10px;
      text-align: center;
    }
    input {
      padding: 8px;
      margin: 5px;
    }
    input[type="text"] {
      width: 200px;
    }
    input[type="number"] {
      width: 120px;
    }
    button {
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.2s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #totals {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }
    #dateDisplay {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold; /* Added for better visibility */
      color: #333; /* Adjusted color for better readability */
    }
    .edit-btn {
      background-color: transparent;
      color: #ffc107;
      border: 1px solid #ffc107;
    }
    .edit-btn:hover {
      background-color: #ffc107;
      color: white;
    }
    .del-btn {
      background-color: transparent;
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    .del-btn:hover {
      background-color: #dc3545;
      color: white;
    }
    #addBtn {
      background-color: #007bff;
      color: white;
      border: none;
    }
    #addBtn:hover {
      opacity: 0.9;
    }
    #saveBtn {
      background-color: transparent;
      color: #28a745;
      border: 1px solid #28a745;
      display: block;
      margin: 20px auto 0;
    }
    #saveBtn:hover {
      background-color: #28a745;
      color: white;
    }
    #clearBtn {
      background-color: #6c757d;
      color: white;
      border: none;
    }
    #clearBtn:hover {
      opacity: 0.9;
    }
    #conversionGroup {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }
    #latestRate {
      margin-left: 10px;
      font-size: 0.9em;
      color: #888;
    }
  </style>
</head>
<body>

<div class="tracker">
  <h2>Daily Expense Tracker</h2>
  <div id="dateDisplay"></div>

  <div class="input-group">
    <input type="text" id="category" placeholder="Item" />
    <input type="number" id="amount" placeholder="Amount (INR)" />
    <button id="addBtn" onclick="addExpense()">Add</button>
    <button id="clearBtn" onclick="clearTotals()">Clear</button>
  </div>

  <div id="conversionGroup">
    Conversion Rate (INR ‚Üí MYR): 
    <input type="number" id="conversionRateInput" step="0.001" value="0.056" oninput="updateTotals(); manualSave();" />
    <button onclick="applyLiveRate()">Use Live Rate</button>
    <span id="latestRate">(Live rate: loading...)</span>
  </div>

  <table id="expenseTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Amount (INR)</th>
        <th>Converted (MYR)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="totals">
    Total INR: ‚Çπ<span id="totalINR">0.00</span><br/>
    Total MYR: RM<span id="totalMYR">0.00</span>
  </div>

  <button id="saveBtn" onclick="downloadTXT()">üíæ</button>
</div>

<script>
  let totalINR = 0;
  let expenseList = [];
  let editIndex = null;
  
  // --- Updated Date and Time Display for INDIA TIME ---
  function updateDateDisplay() {
      const now = new Date();
      const dateOptions = {
          weekday: 'long',   // e.g., Thursday
          year: 'numeric',     // e.g., 2025
          month: 'long',       // e.g., July
          day: 'numeric',      // e.g., 3
          timeZone: 'Asia/Kolkata' // Specify India Standard Time
      };
      const timeOptions = {
          hour: '2-digit',     // e.g., 09
          minute: '2-digit',   // e.g., 40
          second: '2-digit',   // e.g., 27
          hour12: true,        // e.g., AM/PM
          timeZone: 'Asia/Kolkata' // Specify India Standard Time
      };
      const dateStr = now.toLocaleDateString('en-US', dateOptions);
      const timeStr = now.toLocaleTimeString('en-US', timeOptions);
      document.getElementById("dateDisplay").textContent = `${dateStr} - ${timeStr}`;
  }
  // --- End Updated Date and Time Display ---

  function getConversionRate() {
    const rateInput = document.getElementById("conversionRateInput");
    const rate = parseFloat(rateInput.value);
    return isNaN(rate) ? 0.056 : rate;
  }

  function addExpense() {
    const category = document.getElementById("category").value.trim();
    const amount = parseFloat(document.getElementById("amount").value);
    if (!category || isNaN(amount) || amount <= 0) { // Added amount validation
      alert("Please enter a valid item and a positive amount.");
      return;
    }

    if (editIndex !== null) {
      // No need to subtract totalINR here, it's recalculated in updateTotals
      expenseList[editIndex] = { category, amount };
      editIndex = null;
    } else {
      expenseList.push({ category, amount });
    }

    updateTable();
    updateTotals();
    manualSave();
    clearInputs();
  }

  function clearInputs() {
    document.getElementById("category").value = "";
    document.getElementById("amount").value = "";
    editIndex = null;
  }

  // Changed clearTotals to clear all expense entries and then update totals.
  // If you meant to zero out the amounts but keep the items, let me know.
  function clearTotals() {
      if (confirm('Are you sure you want to clear all expense entries?')) {
          expenseList = [];
          updateTable();
          updateTotals();
          manualSave();
      }
  }

  function updateTable() {
    const tbody = document.querySelector("#expenseTable tbody");
    tbody.innerHTML = "";
    const rate = getConversionRate();

    expenseList.forEach((item, index) => {
      const row = tbody.insertRow();
      const converted = item.amount * rate;
      row.innerHTML = `
        <td>${item.category}</td>
        <td>‚Çπ${item.amount.toFixed(2)}</td>
        <td>RM${converted.toFixed(2)}</td>
        <td>
          <button class="edit-btn" onclick="editExpense(${index})">‚úèÔ∏è</button>
          <button class="del-btn" onclick="deleteExpense(${index})">üóëÔ∏è</button>
        </td>
      `;
    });
  }

  function editExpense(index) {
    document.getElementById("category").value = expenseList[index].category;
    document.getElementById("amount").value = expenseList[index].amount;
    editIndex = index;
    // Update button text to "Update" when in edit mode, optional
    // document.getElementById("addBtn").textContent = "Update"; 
  }

  function deleteExpense(index) {
    if (confirm('Are you sure you want to delete this entry?')) {
        expenseList.splice(index, 1);
        updateTable();
        updateTotals();
        manualSave();
    }
  }

  function updateTotals() {
    const rate = getConversionRate();
    totalINR = expenseList.reduce((sum, item) => sum + item.amount, 0);
    const totalMYR = totalINR * rate;
    document.getElementById("totalINR").textContent = totalINR.toFixed(2);
    document.getElementById("totalMYR").textContent = totalMYR.toFixed(2);
  }

  function manualSave() {
    localStorage.setItem("expenseList", JSON.stringify(expenseList));
    localStorage.setItem("conversionRate", getConversionRate().toString());
  }

  function downloadTXT() {
    const now = new Date(); // Get current date/time for the filename and content
    const dateStr = now.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      timeZone: 'Asia/Kolkata' // India Time for the date string in the file
    });
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true,
        timeZone: 'Asia/Kolkata' // India Time for the time string in the file
    });

    const conversionRate = getConversionRate();
    let txtContent = `Daily Expense Tracker - ${dateStr} ${timeStr} (India Time)\n\n`; // Indicate India Time
    txtContent += `Conversion Rate: 1 INR = ${conversionRate.toFixed(3)} MYR\n\n`;
    txtContent += `Item\tAmount (INR)\tConverted (MYR)\n`;
    txtContent += `----\t-------------\t----------------\n`;

    expenseList.forEach(item => {
      const converted = item.amount * conversionRate;
      txtContent += `${item.category}\t‚Çπ${item.amount.toFixed(2)}\t\tRM${converted.toFixed(2)}\n`;
    });

    txtContent += `\nTotal INR: ‚Çπ${totalINR.toFixed(2)}\n`;
    txtContent += `Total MYR: RM${(totalINR * conversionRate).toFixed(2)}\n`;

    const blob = new Blob([txtContent], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    // Filename also includes date and time components, adjusted for India time
    const fileNameDate = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Kolkata' }).replace(/\//g, '');
    const fileNameTime = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Kolkata' }).replace(/:/g, '');
    a.download = `Expenses_INR_MYR_${fileNameDate}_${fileNameTime}_IST.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function fetchLiveRate() {
    // open.er-api.com does not require an API key for basic usage
    fetch("https://open.er-api.com/v6/latest/INR")
      .then(res => res.json())
      .then(data => {
        if (data && data.rates && data.rates.MYR) {
          const liveRate = data.rates.MYR;
          document.getElementById("latestRate").textContent = `(Live rate: ${liveRate.toFixed(3)} MYR)`;
        } else {
          document.getElementById("latestRate").textContent = `(‚ö†Ô∏è Failed to get rate)`;
        }
      })
      .catch(() => {
        document.getElementById("latestRate").textContent = `(‚ö†Ô∏è Failed to fetch rate)`;
      });
  }

  function applyLiveRate() {
    const latest = document.getElementById("latestRate").textContent.match(/([\d.]+)/);
    if (latest && latest[1]) {
      document.getElementById("conversionRateInput").value = parseFloat(latest[1]).toFixed(3);
      updateTotals();
      manualSave();
    } else {
        alert("Live rate not available or failed to fetch. Cannot apply.");
    }
  }

  function loadData() {
    const savedExpenses = localStorage.getItem("expenseList");
    const savedRate = localStorage.getItem("conversionRate");
    if (savedExpenses) {
        expenseList = JSON.parse(savedExpenses);
    }
    if (savedRate) {
        document.getElementById("conversionRateInput").value = parseFloat(savedRate).toFixed(3);
    }
    updateTable(); // Render table with loaded data
    updateTotals(); // Calculate totals with loaded data
  }

  window.onload = function () {
    updateDateDisplay(); // Display date and time on load
    loadData(); // Load saved data
    fetchLiveRate(); // Fetch live rate
    
    // Update date and time every second for real-time display
    setInterval(updateDateDisplay, 1000); 
  };
</script>

</body>
</html>
