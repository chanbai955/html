<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IWK Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
        }
        .screen {
            display: none; /* Hidden by default */
        }
        .screen.active {
            display: block; /* Shown when active */
        }
        .button-group {
            margin-top: 20px;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.red {
            background-color: #dc3545;
        }
        button.red:hover {
            background-color: #c82333;
        }
        button.green {
            background-color: #28a745;
        }
        button.green:hover {
            background-color: #218838;
        }
        /* Styles for the individual property items in the list */
        .property-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack info and buttons vertically */
            gap: 8px; /* Space between info and buttons */
        }
        .property-item-info {
            flex-grow: 1; /* Allows info to take available space */
            cursor: pointer; /* Still clickable for details screen */
            padding-bottom: 5px; /* Little padding above buttons */
        }
        .property-item-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end; /* Align buttons to the right */
            border-top: 1px solid #eee;
            padding-top: 8px;
            margin-top: 5px;
        }
        .property-item-actions button {
            padding: 5px 10px; /* Smaller buttons */
            font-size: 0.9em;
            margin: 0; /* Remove extra margin */
        }

        /* Status-specific background and border */
        .property-item.paid {
            background-color: #e8f5e9; /* Very light green */
            border-color: #c8e6c9; /* Light green border */
        }
        .property-item.pending {
            background-color: #e3f2fd; /* Light blue */
            border-color: #90caf9; /* Blue border */
        }
        /* Status text specific styling within the item */
        .property-item strong {
            color: #0056b3; /* Default text color for property name */
        }
        .property-item.paid strong {
            color: #2e7d32; /* Darker green for paid name */
        }
        .property-item.pending strong {
            color: #1976d2; /* Darker blue for pending name */
        }
        .property-item .status-text.paid-text {
            color: #28a745; /* Green for "Paid" text */
            font-weight: bold;
        }
        .property-item .status-text.pending-text {
            color: #007bff; /* Blue for "Pending" text */
            font-weight: bold;
        }
        /* End of property-item specific styles */

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Style for read-only inputs */
        input[readonly] {
            background-color: #e9ecef; /* Light gray background */
            cursor: not-allowed; /* Indicate it's not editable */
        }
        .detail-field {
            margin-bottom: 10px;
        }
        .detail-field strong {
            display: inline-block;
            width: 120px;
            color: #0056b3;
        }
        /* Styling for Next Payment Due */
        .detail-field.next-payment-info {
            font-weight: bold;
            color: #8a6d3b; /* A subtle warning/info color */
            border-top: 1px dashed #ddd;
            padding-top: 10px;
            margin-top: 15px;
        }
        .detail-field.next-payment-info strong {
            color: #5e4726; /* Darker color for label */
        }


        #statusToggle {
            margin-top: 5px;
        }
        .summary {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
            color: #0056b3;
        }
        .receipt-btn-group {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: center;
            display: flex; /* Use flexbox for button alignment */
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between buttons and input */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .receipt-btn-group button {
            background-color: #6c757d;
        }
        .receipt-btn-group button:hover {
            background-color: #5a6268;
        }
        /* Style for hidden file input */
        .receipt-btn-group input[type="file"] {
            display: none; /* Hide the default file input */
        }
        /* Style for custom upload button */
        .receipt-btn-group label.upload-button {
            background-color: #ffc107; /* Yellowish color for upload */
            color: #333;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            display: inline-block; /* Make label behave like a button */
        }
        .receipt-btn-group label.upload-button:hover {
            background-color: #e0a800;
        }


        /* New styles for specific council link */
        .specific-council-link-display {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            text-align: center;
            font-size: 0.9em;
        }
        .specific-council-link-display p {
            margin-bottom: 8px;
            font-weight: bold;
        }
        .specific-council-link-display a {
            display: inline-block;
            margin: 0 8px;
            color: #007bff;
            text-decoration: none;
            padding: 5px 8px;
            border: 1px solid #007bff;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        .specific-council-link-display a:hover {
            background-color: #007bff;
            color: white;
        }

        /* Styles for the delete icon next to uploaded file name */
        .uploaded-file-display {
            display: flex; /* To align filename and icon */
            justify-content: center;
            align-items: center;
            gap: 5px; /* Space between text and icon */
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
            font-weight: normal; /* Default */
        }

        .uploaded-file-display.attached {
            font-weight: bold;
            color: #28a745; /* Green for attached file */
        }
        .uploaded-file-display .view-link {
            color: #007bff; /* Blue for the view link */
            text-decoration: underline;
            cursor: pointer;
            margin-right: 5px;
        }
        .uploaded-file-display .view-link:hover {
            color: #0056b3;
        }


        .delete-receipt-icon {
            cursor: pointer;
            color: #dc3545; /* Red color for delete */
            font-weight: bold;
            font-size: 1.1em;
            padding: 2px 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .delete-receipt-icon:hover {
            background-color: #f8d7da; /* Light red background on hover */
        }

        /* Styling for the next payment month/year group */
        .next-payment-period-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .next-payment-period-group select,
        .next-payment-period-group input {
            width: auto; /* Allow auto width for smaller inputs */
            flex: 1; /* Distribute space */
            margin-bottom: 0; /* Remove default margin-bottom */
        }

        /* Style for the diskette icon button */
        .save-summary-icon-button {
            background-color: transparent; /* Transparent background */
            border: 2px solid #28a745; /* Green border */
            color: #28a745; /* Green icon color */
            font-size: 24px; /* Larger icon size */
            padding: 8px 12px; /* Adjust padding for icon */
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            display: inline-flex; /* To center the icon */
            align-items: center;
            justify-content: center;
        }

        .save-summary-icon-button:hover {
            background-color: #28a745; /* Green background on hover */
            color: white; /* White icon on hover */
            border-color: #218838; /* Darker green border on hover */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Indah Water Konsortium</h1>

        <div id="homeScreen" class="screen active">
            <h2> @ Properties-ku</h2>
            <div class="summary" id="summaryView"></div>
            <div id="propertyList">
                </div>
            <div class="button-group">
                <button onclick="showScreen('addEditScreen', 'new')">Add New Property</button>
            </div>
            <div class="button-group">
                <button class="save-summary-icon-button" onclick="saveSummaryAsPdf()" title="Save Summary as PDF">
                    💾
                </button>
            </div>
        </div>

        <div id="addEditScreen" class="screen">
            <h2 id="addEditTitle">Add New Property</h2>
            <form id="propertyForm">
                <input type="hidden" id="propertyIndex">
                
                <label for="propertyName">Name:</label>
                <input type="text" id="propertyName" placeholder="e.g., My House, Shop Lot A" required>

                <label for="accNo">Account Number (Acc No):</label>
                <input type="text" id="accNo" required>

                <label for="council">Council:</label>
                <select id="council" required>
                    <option value="">-- Select Council --</option>
                    <option value="IWK_Main">Indah Water Konsortium (IWK)</option>
                    <option value="Private_Tamotaran">Private-Tamotaran-0122710800 (IWK)</option>
                    <option value="Private_Yogeswaran">Private-Yogeswaran-0122404673 (IWK)</option>
                </select>

                <label for="amount">Amount (RM):</label>
                <input type="number" id="amount" step="0.01" required>

                <label for="duration">Duration:</label>
                <select id="duration" required>
                    <option value="Jan-Jun">Jan-Jun</option>
                    <option value="Jul-Dec">Jul-Dec</option>
                    <option value="One Year">One Year</option>
                    <option value="Two Years">Two Years</option>
                    <option value="Three Years">Three Years</option>
                </select>

                <label for="year">Year:</label>
                <input type="number" id="year" value="2025" min="2020" max="2100" required>

                <label>Status:</label>
                <input type="radio" id="statusPending" name="status" value="Pending" checked>
                <label for="statusPending" style="display: inline-block; margin-right: 10px;">Pending</label>
                <input type="radio" id="statusPaid" name="status" value="Paid">
                <label for="statusPaid" style="display: inline-block;">Paid</label>
                
                <div id="paymentDateGroup" style="display: none;">
                    <label for="paymentDate">Payment Date:</label>
                    <input type="date" id="paymentDate">
                </div>

                <label for="receiptId">Receipt/Transaction ID (Optional):</label>
                <input type="text" id="receiptId">

                <hr style="margin-top: 20px; border-style: dashed; border-width: 1px 0 0 0; border-color: #ddd;">
                <h3 style="text-align: center; color: #0056b3;">Next Payment Details</h3>
                
                <label for="nextPaymentDuration">Next Payment Duration:</label>
                <select id="nextPaymentDuration" required>
                    <option value="">-- Select Duration --</option>
                    <option value="Jan-Jun">Jan-Jun</option>
                    <option value="Jul-Dec">Jul-Dec</option>
                    
                </select>

                <label for="nextPaymentYear">Next Payment Year:</label>
                <input type="number" id="nextPaymentYear" value="2026" min="2020" max="2100" required>

                <div class="button-group">
                    <button type="submit">Save Property</button>
                    <button type="button" onclick="showScreen('homeScreen')">Cancel</button>
                </div>
            </form>
        </div>

        <div id="propertyDetailsScreen" class="screen">
            <h2>Property Details</h2>
            <div id="detailsDisplay">
                <div class="detail-field"><strong>Name:</strong> <span id="detailName"></span></div>
                <div class="detail-field"><strong>Acc No:</strong> <span id="detailAccNo"></span></div>
                <div class="detail-field"><strong>Council:</strong> <span id="detailCouncil"></span></div>
                <div class="detail-field"><strong>Amount:</strong> RM <span id="detailAmount"></span></div>
                <div class="detail-field"><strong>Duration:</strong> <span id="detailDuration"></span></div>
                <div class="detail-field"><strong>Year:</strong> <span id="detailYear"></span></div>
                <div class="detail-field"><strong>Status:</strong> <span id="detailStatus"></span></div>
                <div class="detail-field" id="detailPaymentDateGroup"><strong>Paid On:</strong> <span id="detailPaymentDate"></span></div>
                <div class="detail-field" id="detailReceiptIdGroup"><strong>Receipt ID:</strong> <span id="detailReceiptId"></span></div>
                <div class="detail-field next-payment-info"><strong>Next Payment Due:</strong> <span id="detailNextPaymentDue"></span></div>
            </div>

            <div id="specificCouncilLinkDisplay" class="specific-council-link-display">
                </div>

            <div class="button-group">
                <button id="editPropertyBtn" onclick="editCurrentProperty()">Edit</button>
                <button id="markAsPaidBtn" onclick="markCurrentPropertyAsPaid()">Mark as Paid</button>
                <button class="red" onclick="deleteCurrentProperty()">Delete</button>
                <button onclick="showScreen('homeScreen')">Back to List</button>
            </div>
            
            <div class="receipt-btn-group" id="downloadReceiptGroup">
                <button class="green" onclick="downloadPdfReceipt()">Download Receipt </button>
                
                <input type="file" id="uploadReceiptInput" accept=".pdf">
                <label for="uploadReceiptInput" class="upload-button">Upload Bill</label>
            </div>
            
            <div id="uploadedReceiptFileName" class="uploaded-file-display">
                </div>

        </div>

        <div id="settingsAboutScreen" class="screen">
            <h2>Settings & About</h2>
            <p>This is a simple IWK tracking app.</p>
            <p>Version 1.0</p>
            <div class="button-group">
                <button onclick="showScreen('homeScreen')">Back to Home</button>
            </div>
        </div>

    </div>

    <script>
        const { jsPDF } = window.jspdf;

        let properties = [];
        let currentPropertyIndex = -1;
        let db; // Variable to hold the IndexedDB database instance

        const DB_NAME = 'IWKTrackerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'receipts';

        // --- IndexedDB Functions ---

        /**
         * Opens the IndexedDB database and creates object stores if necessary.
         * @returns {Promise<IDBDatabase>} A promise that resolves with the database instance.
         */
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        // You can add indexes here if you need to query by other fields later
                        // objectStore.createIndex('accNo', 'accNo', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * Stores a File/Blob in IndexedDB.
         * @param {string} id The unique ID for the receipt (e.g., property.accNo + timestamp).
         * @param {string} fileName The name of the file.
         * @param {File} fileBlob The actual File or Blob object to store.
         * @returns {Promise<void>} A promise that resolves when the file is stored.
         */
        function storeReceiptInIndexedDB(id, fileName, fileBlob) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.put({ id: id, name: fileName, data: fileBlob }); // Store id, name, and the Blob

                request.onsuccess = () => {
                    console.log(`Receipt ${fileName} stored in IndexedDB with ID: ${id}`);
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('Error storing receipt in IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * Retrieves a File/Blob from IndexedDB by its ID.
         * @param {string} id The unique ID of the receipt.
         * @returns {Promise<File|Blob|null>} A promise that resolves with the File/Blob or null if not found.
         */
        function getReceiptFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.get(id);

                request.onsuccess = (event) => {
                    const record = event.target.result;
                    if (record && record.data) {
                        console.log(`Receipt with ID ${id} retrieved from IndexedDB.`);
                        resolve(record.data); // Return the Blob/File
                    } else {
                        console.log(`Receipt with ID ${id} not found in IndexedDB.`);
                        resolve(null);
                    }
                };

                request.onerror = (event) => {
                    console.error('Error retrieving receipt from IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /**
         * Deletes a receipt from IndexedDB by its ID.
         * @param {string} id The unique ID of the receipt to delete.
         * @returns {Promise<void>} A promise that resolves when the receipt is deleted.
         */
        function deleteReceiptFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    console.log(`Receipt with ID ${id} deleted from IndexedDB.`);
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('Error deleting receipt from IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // --- Existing Code (Modified for IndexedDB integration) ---

        // Council URL Mapping
        const COUNCIL_URLS = {
            "IWK_Main": { name: "Indah Water Konsortium (IWK)", url: "https://www.iwk.com.my/" },
            "Private_Tamotaran": { name: "Private-Tamotaran-0122710800 (IWK)", url: "https://www.iwk.com.my/" },
            "Private_Yogeswaran": { name: "Private-Yogeswaran-0122404673 (IWK)", url: "https://www.iwk.com.my/" }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Open IndexedDB first
            try {
                await openDatabase();
            } catch (error) {
                alert('Failed to open database. Receipt functionality may be limited.');
                console.error('Failed to open IndexedDB on startup:', error);
            }

            const storedProperties = localStorage.getItem('iwkProperties');
            if (storedProperties) {
                properties = JSON.parse(storedProperties);
            }
            renderProperties();
            updateSummary();

            document.getElementById('statusPaid').addEventListener('change', togglePaymentDateInput);
            document.getElementById('statusPending').addEventListener('change', togglePaymentDateInput);

            document.getElementById('uploadReceiptInput').addEventListener('change', handleReceiptUpload);
        });

        function saveProperties() {
            localStorage.setItem('iwkProperties', JSON.stringify(properties));
        }

        function showScreen(screenId, mode = 'view', index = -1) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            if (screenId === 'addEditScreen') {
                const form = document.getElementById('propertyForm');
                form.reset();
                document.getElementById('propertyIndex').value = '';
                document.getElementById('addEditTitle').textContent = 'Add New Property';
                document.getElementById('statusPending').checked = true;
                document.getElementById('paymentDateGroup').style.display = 'none';

                const propertyNameInput = document.getElementById('propertyName');
                const accNoInput = document.getElementById('accNo');
                const councilSelect = document.getElementById('council');
                const nextPaymentDurationSelect = document.getElementById('nextPaymentDuration');
                const nextPaymentYearInput = document.getElementById('nextPaymentYear');


                if (mode === 'edit' && index !== -1) {
                    currentPropertyIndex = index;
                    const prop = properties[index];
                    document.getElementById('addEditTitle').textContent = 'Edit Property';
                    document.getElementById('propertyIndex').value = index;
                    
                    propertyNameInput.value = prop.name;
                    accNoInput.value = prop.accNo;
                    councilSelect.value = prop.council || '';
                    nextPaymentDurationSelect.value = prop.nextPaymentDuration || '';
                    nextPaymentYearInput.value = prop.nextPaymentYear || '';

                    propertyNameInput.readOnly = true;
                    accNoInput.readOnly = true;
                    councilSelect.disabled = true;
                    
                    propertyNameInput.classList.add('readonly-input');
                    accNoInput.classList.add('readonly-input');
                    councilSelect.classList.add('readonly-input');


                    document.getElementById('amount').value = prop.amount;
                    document.getElementById('duration').value = prop.duration;
                    document.getElementById('year').value = prop.year;
                    if (prop.status === 'Paid') {
                        document.getElementById('statusPaid').checked = true;
                        document.getElementById('paymentDate').value = prop.paymentDate || '';
                        document.getElementById('receiptId').value = prop.receiptId || '';
                        document.getElementById('paymentDateGroup').style.display = 'block';
                    } else {
                        document.getElementById('statusPending').checked = true;
                        document.getElementById('paymentDateGroup').style.display = 'none';
                    }
                } else {
                    propertyNameInput.readOnly = false;
                    accNoInput.readOnly = false;
                    councilSelect.disabled = false;
                    
                    propertyNameInput.classList.remove('readonly-input');
                    accNoInput.classList.remove('readonly-input');
                    councilSelect.classList.remove('readonly-input');
                    councilSelect.value = '';
                    
                    nextPaymentDurationSelect.value = 'Jan-Jun';
                    nextPaymentYearInput.value = (new Date().getFullYear() + 1);
                }
            } else if (screenId === 'propertyDetailsScreen') {
                currentPropertyIndex = index;
                displayPropertyDetails(index);
            }
            updateSummary();
        }

        function togglePaymentDateInput() {
            const statusPaid = document.getElementById('statusPaid').checked;
            document.getElementById('paymentDateGroup').style.display = statusPaid ? 'block' : 'none';
            if (!statusPaid) {
                document.getElementById('paymentDate').value = '';
                document.getElementById('receiptId').value = '';
            }
        }

        document.getElementById('propertyForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const index = document.getElementById('propertyIndex').value;
            const name = document.getElementById('propertyName').value;
            const accNo = document.getElementById('accNo').value;
            const council = document.getElementById('council').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const duration = document.getElementById('duration').value;
            const year = parseInt(document.getElementById('year').value);
            const status = document.querySelector('input[name="status"]:checked').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const receiptId = document.getElementById('receiptId').value;
            const nextPaymentDuration = document.getElementById('nextPaymentDuration').value;
            const nextPaymentYear = parseInt(document.getElementById('nextPaymentYear').value);

            // Important: Preserve IndexedDB receipt ID and name if editing and status is Paid
            let existingReceiptId = '';
            let existingUploadedReceiptName = '';
            if (index !== '' && properties[parseInt(index)] && status === 'Paid') {
                existingReceiptId = properties[parseInt(index)].receiptID_IndexedDB || '';
                existingUploadedReceiptName = properties[parseInt(index)].uploadedReceiptName || '';
            }


            const newProperty = {
                name,
                accNo,
                council,
                amount,
                duration,
                year,
                status,
                paymentDate: status === 'Paid' ? paymentDate : '',
                receiptId: status === 'Paid' ? receiptId : '',
                nextPaymentDuration,
                nextPaymentYear,
                // Only store the ID for IndexedDB, not the Base64 data
                receiptID_IndexedDB: existingReceiptId,
                uploadedReceiptName: existingUploadedReceiptName
            };

            if (index === '') {
                properties.push(newProperty);
            } else {
                properties[parseInt(index)] = newProperty;
            }

            saveProperties();
            renderProperties();
            showScreen('homeScreen');
        });

        function renderProperties() {
            const propertyListDiv = document.getElementById('propertyList');
            propertyListDiv.innerHTML = '';

            if (properties.length === 0) {
                propertyListDiv.innerHTML = '<p style="text-align: center; margin-top: 20px;">No properties added yet. Click "Add New Property" to get started! 🏠</p>';
                return;
            }

            properties.forEach((prop, index) => {
                const propDiv = document.createElement('div');
                propDiv.classList.add('property-item');
                if (prop.status === 'Paid') {
                    propDiv.classList.add('paid');
                } else {
                    propDiv.classList.add('pending');
                }

                let paymentDateHtml = '';
                if (prop.status === 'Paid' && prop.paymentDate) {
                    try {
                        const [year, month, day] = prop.paymentDate.split('-').map(Number);
                        const dateObj = new Date(year, month - 1, day);
                        if (!isNaN(dateObj.getTime())) {
                            paymentDateHtml = `Paid On: ${dateObj.toLocaleDateString('en-GB')}<br>`;
                        }
                    } catch (e) {
                        console.error("Error parsing payment date:", prop.paymentDate, e);
                        paymentDateHtml = `Paid On: Invalid Date<br>`;
                    }
                }

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('property-item-info');
                infoDiv.innerHTML = `
                    <strong>${prop.name}</strong><br>
                    Acc No: ${prop.accNo}<br>
                    Council: ${COUNCIL_URLS[prop.council] ? COUNCIL_URLS[prop.council].name : 'N/A'}<br>
                    Amount: RM ${prop.amount.toFixed(2)}<br>
                    Duration: ${prop.duration} ${prop.year}<br>
                    Status: <span class="status-text ${prop.status.toLowerCase()}-text">${prop.status}</span><br>
                    ${paymentDateHtml} Next Due: <strong>${prop.nextPaymentDuration || 'N/A'} ${prop.nextPaymentYear || ''}</strong>
                `;
                infoDiv.onclick = (event) => {
                    if (!event.target.closest('.property-item-actions')) {
                        showScreen('propertyDetailsScreen', 'view', index);
                    }
                };
                propDiv.appendChild(infoDiv);

                propertyListDiv.appendChild(propDiv);
            });
            updateSummary();
        }

        function updateSummary() {
            let pendingCount = 0;
            let totalDue = 0;

            properties.forEach(prop => {
                if (prop.status === 'Pending') {
                    pendingCount++;
                    totalDue += prop.amount;
                }
            });

            const summaryView = document.getElementById('summaryView');
            summaryView.innerHTML = `
                You have <strong>${pendingCount} pending</strong> payments totaling <strong>RM ${totalDue.toFixed(2)}</strong>.
            `;
        }

        function displayPropertyDetails(index) {
            currentPropertyIndex = index;

            if (currentPropertyIndex === -1 || !properties[currentPropertyIndex]) {
                console.error("Invalid property index for details display:", currentPropertyIndex);
                alert("Error: Could not load property details. Please try again.");
                showScreen('homeScreen');
                return;
            }

            const prop = properties[currentPropertyIndex];

            document.getElementById('detailName').textContent = prop.name;
            document.getElementById('detailAccNo').textContent = prop.accNo;
            document.getElementById('detailCouncil').textContent = COUNCIL_URLS[prop.council] ? COUNCIL_URLS[prop.council].name : 'N/A';

            document.getElementById('detailAmount').textContent = prop.amount.toFixed(2);
            document.getElementById('detailDuration').textContent = prop.duration;
            document.getElementById('detailYear').textContent = prop.year;
            document.getElementById('detailStatus').textContent = prop.status;

            const paymentDateGroup = document.getElementById('detailPaymentDateGroup');
            if (prop.paymentDate) {
                try {
                    const [year, month, day] = prop.paymentDate.split('-').map(Number);
                    const dateObj = new Date(year, month - 1, day);
                    if (!isNaN(dateObj.getTime())) {
                        document.getElementById('detailPaymentDate').textContent = dateObj.toLocaleDateString('en-GB');
                    } else {
                        document.getElementById('detailPaymentDate').textContent = 'Invalid Date';
                    }
                } catch (e) {
                    console.error("Error parsing payment date for details:", prop.paymentDate, e);
                    document.getElementById('detailPaymentDate').textContent = 'Error parsing date';
                }
            } else {
                document.getElementById('detailPaymentDate').textContent = 'N/A';
            }
            paymentDateGroup.style.display = 'block';

            const receiptIdGroup = document.getElementById('detailReceiptIdGroup');
            document.getElementById('detailReceiptId').textContent = prop.receiptId || 'N/A';
            receiptIdGroup.style.display = 'block';

            const markAsPaidBtn = document.getElementById('markAsPaidBtn');
            const downloadReceiptGroup = document.getElementById('downloadReceiptGroup');
            const uploadedReceiptFileNameDisplay = document.getElementById('uploadedReceiptFileName');

            if (prop.status === 'Paid') {
                markAsPaidBtn.style.display = 'none';
                downloadReceiptGroup.style.display = 'flex';
            } else {
                markAsPaidBtn.style.display = 'inline-block';
                downloadReceiptGroup.style.display = 'none';
            }

            uploadedReceiptFileNameDisplay.innerHTML = '';

            // Check if there's a receipt ID stored for IndexedDB
            if (prop.receiptID_IndexedDB && prop.uploadedReceiptName) {
                uploadedReceiptFileNameDisplay.classList.add('attached');
                uploadedReceiptFileNameDisplay.innerHTML = `
                    Attached Receipt: <span class="view-link" onclick="viewUploadedPdf()"><u>${prop.uploadedReceiptName}</u></span>
                    <span class="delete-receipt-icon" onclick="deleteUploadedReceipt()">✗</span>
                `;
            } else {
                uploadedReceiptFileNameDisplay.classList.remove('attached');
                uploadedReceiptFileNameDisplay.textContent = 'No PDF receipt attached.';
            }

            const specificCouncilLinkDisplay = document.getElementById('specificCouncilLinkDisplay');
            specificCouncilLinkDisplay.innerHTML = '';

            if (prop.council && COUNCIL_URLS[prop.council]) {
                const councilInfo = COUNCIL_URLS[prop.council];
                specificCouncilLinkDisplay.innerHTML = `
                    <p>Visit Your Council's Website:</p>
                    <a href="${councilInfo.url}" target="_blank" rel="noopener noreferrer">${councilInfo.name}</a>
                `;
            } else {
                specificCouncilLinkDisplay.innerHTML = '<p>No specific council link available.</p>';
            }

            const nextPaymentDueElement = document.getElementById('detailNextPaymentDue');
            if (prop.nextPaymentDuration && prop.nextPaymentYear) {
                nextPaymentDueElement.textContent = `${prop.nextPaymentDuration} ${prop.nextPaymentYear}`;
            } else {
                nextPaymentDueElement.textContent = 'N/A';
            }
        }

        function editCurrentProperty() {
            if (currentPropertyIndex !== -1) {
                showScreen('addEditScreen', 'edit', currentPropertyIndex);
            } else {
                alert("Please select a property to edit.");
            }
        }

        function markCurrentPropertyAsPaid() {
            if (currentPropertyIndex !== -1) {
                const prop = properties[currentPropertyIndex];
                if (prop.status === 'Pending') {
                    const paymentDate = prompt("Enter Payment Date (YYYY-MM-DD):");
                    if (paymentDate) {
                        if (!/^\d{4}-\d{2}-\d{2}$/.test(paymentDate)) {
                            alert("Invalid date format. Please use YYYY-MM-DD.");
                            return;
                        }
                        const receiptId = prompt("Enter Receipt/Transaction ID (Optional):");
                        prop.status = 'Paid';
                        prop.paymentDate = paymentDate;
                        prop.receiptId = receiptId || '';
                        saveProperties();
                        renderProperties();
                        displayPropertyDetails(currentPropertyIndex);
                        alert('Property marked as Paid! 🎉');
                    } else {
                        alert('Payment date is required to mark as paid.');
                    }
                } else {
                    alert('This property is already marked as Paid.');
                }
            } else {
                alert("Please select a property to mark as paid.");
            }
        }

        async function deleteCurrentProperty() {
            if (currentPropertyIndex !== -1 && confirm('Are you sure you want to delete this property record?')) {
                const propToDelete = properties[currentPropertyIndex];
                if (propToDelete.receiptID_IndexedDB) {
                    try {
                        await deleteReceiptFromIndexedDB(propToDelete.receiptID_IndexedDB);
                    } catch (error) {
                        console.error("Failed to delete receipt from IndexedDB:", error);
                        alert("Failed to delete the associated receipt file. You might need to manually clear your browser's site data.");
                    }
                }
                properties.splice(currentPropertyIndex, 1);
                saveProperties();
                renderProperties();
                showScreen('homeScreen');
                currentPropertyIndex = -1;
                alert('Property deleted successfully. 🗑️');
            } else if (currentPropertyIndex === -1) {
                alert("No property selected for deletion.");
            }
        }

        async function deleteUploadedReceipt() {
            if (currentPropertyIndex !== -1 && properties[currentPropertyIndex].receiptID_IndexedDB) {
                const prop = properties[currentPropertyIndex];
                if (confirm(`Are you sure you want to remove the attached receipt "${prop.uploadedReceiptName}"?`)) {
                    try {
                        await deleteReceiptFromIndexedDB(prop.receiptID_IndexedDB);
                        prop.receiptID_IndexedDB = ''; // Clear the ID from localStorage data
                        prop.uploadedReceiptName = ''; // Clear the name
                        saveProperties();
                        displayPropertyDetails(currentPropertyIndex);
                        alert('Attached receipt removed successfully. 🧹');
                    } catch (error) {
                        console.error("Error deleting receipt:", error);
                        alert("Failed to remove attached receipt. Please try again.");
                    }
                }
            } else {
                alert("No receipt to remove for this property.");
            }
        }

        async function viewUploadedPdf() {
            if (currentPropertyIndex === -1 || !properties[currentPropertyIndex] || !properties[currentPropertyIndex].receiptID_IndexedDB) {
                alert("No uploaded PDF receipt found for this property.");
                return;
            }
            const prop = properties[currentPropertyIndex];

            try {
                const pdfBlob = await getReceiptFromIndexedDB(prop.receiptID_IndexedDB);
                if (pdfBlob) {
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    window.open(pdfUrl, '_blank');
                    setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                } else {
                    alert("PDF receipt not found in storage. It might have been deleted or corrupted.");
                }
            } catch (e) {
                console.error("Error viewing PDF from IndexedDB:", e);
                alert("Could not view PDF. An internal error occurred.");
            }
        }

        async function downloadPdfReceipt() {
            if (currentPropertyIndex === -1) {
                alert("Please select a property to download its receipt.");
                return;
            }

            const prop = properties[currentPropertyIndex];

            if (prop.status !== 'Paid') {
                alert('Receipt can only be downloaded for paid properties.');
                return;
            }

            const doc = new jsPDF();

            doc.setFontSize(22);
            doc.text("PAYMENT RECEIPT", 105, 20, { align: "center" });

            let receiptDisplayDate = new Date().toLocaleDateString('en-GB');
            if (prop.paymentDate) {
                try {
                    const [year, month, day] = prop.paymentDate.split('-').map(Number);
                    const paymentDateObj = new Date(year, month - 1, day);
                    if (!isNaN(paymentDateObj.getTime())) {
                        receiptDisplayDate = paymentDateObj.toLocaleDateString('en-GB');
                    }
                } catch (e) {
                    console.warn("Invalid payment date format for receipt, using current date.");
                }
            }

            doc.setFontSize(12);
            doc.text(`Date of Receipt: ${receiptDisplayDate}`, 20, 30);

            doc.setLineWidth(0.5);
            doc.line(20, 32, 190, 32);

            let yPos = 40;
            const lineHeight = 7;

            doc.text(`Property Name:     ${prop.name}`, 20, yPos); yPos += lineHeight;
            doc.text(`Account No:        ${prop.accNo}`, 20, yPos); yPos += lineHeight;
            doc.text(`Council:           ${COUNCIL_URLS[prop.council] ? COUNCIL_URLS[prop.council].name : 'N/A'}`, 20, yPos); yPos += lineHeight;
            doc.text(`Assessment Year: ${prop.year} (${prop.duration})`, 20, yPos); yPos += lineHeight * 2;

            doc.setFontSize(14);
            doc.text(`Amount Paid:       RM ${prop.amount.toFixed(2)}`, 20, yPos); yPos += lineHeight;
            doc.setFontSize(12);
            
            let formattedPaymentDate = prop.paymentDate || 'N/A';
            if (prop.paymentDate) {
                try {
                    const [year, month, day] = prop.paymentDate.split('-').map(Number);
                    const dateObj = new Date(year, month - 1, day);
                    if (!isNaN(dateObj.getTime())) {
                        formattedPaymentDate = dateObj.toLocaleDateString('en-GB');
                    }
                } catch (e) {
                    console.error("Error formatting payment date for PDF:", prop.paymentDate, e);
                    formattedPaymentDate = 'Invalid Date';
                }
            }
            doc.text(`Payment Date:      ${formattedPaymentDate}`, 20, yPos); yPos += lineHeight;

            doc.text(`Transaction ID:    ${prop.receiptId || 'N/A'}`, 20, yPos); yPos += lineHeight * 2;

            doc.setLineWidth(0.5);
            doc.line(20, yPos - lineHeight, 190, yPos - lineHeight);

            doc.text("Status:            PAID", 20, yPos); yPos += lineHeight;
            doc.text("Thank you for your payment!", 105, yPos + 10, { align: "center" });

            if (prop.nextPaymentDuration && prop.nextPaymentYear) {
                doc.setFontSize(10);
                doc.text(`Next Payment Due: ${prop.nextPaymentDuration} ${prop.nextPaymentYear}`, 20, yPos + 20);
            }

            const filename = `iwk_Receipt_${prop.name.replace(/\s/g, '_')}_${prop.year}_${prop.accNo}.pdf`;
            doc.save(filename);
            alert('Receipt PDF downloaded! 📥');
        }

        function saveSummaryAsPdf() {
            const doc = new jsPDF();
            const currentDateTime = new Date().toLocaleString('en-GB', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Kuala_Lumpur' });

            doc.setFontSize(22);
            doc.text("IWK Properties Summary", 105, 20, { align: "center" });

            doc.setFontSize(10);
            doc.text(`Report Generated: ${currentDateTime}`, 105, 27, { align: "center" });

            doc.setLineWidth(0.5);
            doc.line(20, 32, 190, 32);

            let yPos = 40;
            const lineHeight = 7;

            let totalProperties = properties.length;
            let paidCount = 0;
            let pendingCount = 0;
            let totalPendingAmount = 0;

            properties.forEach(prop => {
                if (prop.status === 'Paid') {
                    paidCount++;
                } else {
                    pendingCount++;
                    totalPendingAmount += prop.amount;
                }
            });

            doc.setFontSize(14);
            doc.text("Overall Summary:", 20, yPos); yPos += lineHeight * 2;

            doc.setFontSize(12);
            doc.text(`Total Properties: ${totalProperties}`, 20, yPos); yPos += lineHeight;
            doc.text(`Properties Paid: ${paidCount}`, 20, yPos); yPos += lineHeight;
            doc.text(`Properties Pending: ${pendingCount}`, 20, yPos); yPos += lineHeight;
            doc.text(`Total Pending Amount: RM ${totalPendingAmount.toFixed(2)}`, 20, yPos); yPos += lineHeight * 2;

            doc.setLineWidth(0.2);
            doc.line(20, yPos - lineHeight, 190, yPos - lineHeight);

            doc.setFontSize(14);
            doc.text("Property Details:", 20, yPos); yPos += lineHeight * 2;

            if (properties.length === 0) {
                doc.setFontSize(12);
                doc.text("No properties recorded.", 20, yPos);
            } else {
                properties.forEach((prop, index) => {
                    if (yPos + 50 > doc.internal.pageSize.height - 20) {
                        doc.addPage();
                        yPos = 20;
                        doc.setFontSize(14);
                        doc.text("Property Details (continued):", 20, yPos); yPos += lineHeight * 2;
                    }

                    doc.setFontSize(12);
                    doc.text(`- ${prop.name} (Acc No: ${prop.accNo})`, 25, yPos); yPos += lineHeight;
                    doc.setFontSize(10);
                    doc.text(`  Council: ${COUNCIL_URLS[prop.council] ? COUNCIL_URLS[prop.council].name : 'N/A'}`, 30, yPos); yPos += lineHeight;
                    doc.text(`  Amount: RM ${prop.amount.toFixed(2)}`, 30, yPos); yPos += lineHeight;
                    doc.text(`  Duration: ${prop.duration} ${prop.year}`, 30, yPos); yPos += lineHeight;
                    doc.text(`  Status: ${prop.status}`, 30, yPos); yPos += lineHeight;
                    if (prop.status === 'Paid' && prop.paymentDate) {
                        try {
                            const [year, month, day] = prop.paymentDate.split('-').map(Number);
                            const dateObj = new Date(year, month - 1, day);
                            if (!isNaN(dateObj.getTime())) {
                                doc.text(`  Paid On: ${dateObj.toLocaleDateString('en-GB')}`, 30, yPos); yPos += lineHeight;
                            }
                        } catch (e) {
                            console.error("Error formatting payment date for summary PDF:", prop.paymentDate, e);
                        }
                    }
                    if (prop.nextPaymentDuration && prop.nextPaymentYear) {
                        doc.text(`  Next Due: ${prop.nextPaymentDuration} ${prop.nextPaymentYear}`, 30, yPos); yPos += lineHeight;
                    }
                    yPos += lineHeight;
                });
            }

            const filename = `IWK_Summary_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.pdf`;
            doc.save(filename);
            alert('Summary PDF downloaded! 💾');
        }

        // Updated handleReceiptUpload for IndexedDB
        async function handleReceiptUpload(event) {
            if (!db) { // Check if IndexedDB is ready
                alert("Database not ready. Please refresh the page and try again.");
                event.target.value = '';
                return;
            }

            if (currentPropertyIndex === -1 || !properties[currentPropertyIndex]) {
                alert("Please select a valid property before uploading a receipt.");
                event.target.value = '';
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                alert("No file selected.");
                return;
            }

            if (file.type !== 'application/pdf') {
                alert("Only PDF files are allowed.");
                event.target.value = '';
                return;
            }

            // Max upload size check - this is for IndexedDB, which has much higher limits
            // but still good to prevent extremely large files
            const MAX_INDX_UPLOAD_SIZE_MB = 20; // Increased limit for IndexedDB
            const MAX_INDX_UPLOAD_SIZE_BYTES = MAX_INDX_UPLOAD_SIZE_MB * 1024 * 1024;
            if (file.size > MAX_INDX_UPLOAD_SIZE_BYTES) {
                alert(`File size exceeds the limit of ${MAX_INDX_UPLOAD_SIZE_MB}MB. Please choose a smaller file. (Current: ${(file.size / (1024 * 1024)).toFixed(2)}MB)`);
                event.target.value = '';
                return;
            }

            const prop = properties[currentPropertyIndex];
            
            // Generate a unique ID for the receipt in IndexedDB
            // Using property accNo + current timestamp for uniqueness
            const receiptUniqueId = `${prop.accNo}_${Date.now()}`;

            try {
                // If an old receipt exists, delete it first to ensure only one per property
                // This assumes one receipt per property. If you need multiple, data structure needs to change.
                if (prop.receiptID_IndexedDB) {
                    await deleteReceiptFromIndexedDB(prop.receiptID_IndexedDB);
                }

                await storeReceiptInIndexedDB(receiptUniqueId, file.name, file); // Store the File object directly
                
                prop.receiptID_IndexedDB = receiptUniqueId; // Store only the ID in localStorage
                prop.uploadedReceiptName = file.name; // Store the file name in localStorage
                // Base64 property is no longer needed but kept for backward compatibility
                // prop.uploadedReceiptBase64 = ''; // Explicitly clear if it was there

                saveProperties();
                displayPropertyDetails(currentPropertyIndex);
                alert('PDF receipt uploaded successfully! ✅');
                event.target.value = ''; // Clear file input after successful upload
            } catch (error) {
                console.error("Error during receipt upload to IndexedDB:", error);
                alert("Failed to upload PDF receipt. Please check console for details.");
                event.target.value = '';
            }
        }
    </script>
</body>
</html>
